<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <style>
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        .amap-marker-label {
            border: 0;
            background-color: transparent;

        }
    </style>
    <title>GeoJSON</title>
    <!-- <link rel="stylesheet" href="//a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" /> -->
    <script
        src="https://webapi.amap.com/maps?v=1.4.11&key=19b6ffb41d6c37ad488f0d57088e2ebd&plugin=AMap.Riding,AMap.Driving">
    </script>
    <script src="https://webapi.amap.com/loca?v=1.3.2&key=19b6ffb41d6c37ad488f0d57088e2ebd"></script>
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
    <script src="./jquery-3.3.1.min.js"></script>
    <script src="https://a.amap.com/Loca/static/mock/heatmapData.js"></script>
    <script src="https://unpkg.com/gcoord/dist/gcoord.js"></script>
</head>

<body>
    <div id="container"></div>
    <div id="panel"></div>
    <script src="./map.js"></script>
    <script src="./com.js"></script>
    <script src="./setMenu.js"></script>
    <script type="text/javascript">
        $.ajax({
            type: "GET",
            url: 'https://kybcrm-files.oss-cn-hangzhou.aliyuncs.com/prod/tesla/smart-scenic-v2-web/amcharts/1.json',
            async: true,
            contentType: "application/json",
            dataType: "json",
            success: ((geoJSON) => {
                gcoord.transform(geoJSON, gcoord.WGS84, gcoord.GCJ02);
                getGroup(geoJSON);
                let LineStringArr = []
                let filter_features = geoJSON.features.filter(v => {
                    v.height = 0;
                    if (v.geometry.coordinates && !Array.isArray(v.geometry.coordinates[0])) {
                        v.height = v.geometry.coordinates[2] || 0;
                    }
                    if (v.geometry.type == 'LineString') {
                        LineStringArr.push(v)
                    }
                    return v.geometry.type == 'Point'
                })
                // console.log(LineStringArr, 'LineStringArr');
                // let lines = LineStringArr.map((v, i) => {
                //     const coordinates = v.geometry.coordinates
                //     return {
                //         "line_id": "110100010117" + i,
                //         "line_name": v.properties.name,
                //         "lnglat": coordinates
                //     }
                // })
                // layer1.setData(lines, {
                //     lnglat: 'lnglat'
                // }).render();


                // layer.setData(filter_features, {
                //     lnglat: (data) => {
                //         const coordinates = data.value.geometry.coordinates;
                //         return [coordinates[0], coordinates[1]];
                //     },
                //     value: "height",
                // }).render();


                var geojson = new AMap.GeoJSON({
                    geoJSON: geoJSON,
                    getMarker: (geojson, lnglats) => {
                        if (geojson.properties && geojson.properties.name) {
                            const coordinates = geojson.geometry.coordinates
                            let properties = geojson.properties;
                            let marker;
                            marker = _marker(geojson.properties.name, lnglats,
                                defaultIcon0, {
                                    'id': coordinates,
                                    'type': 3 // 0 默认值  1 起点 2 终点
                                })
                            marker.setLabel({
                                offset: new AMap.Pixel(-24, -26), //设置文本标注偏移量
                                content: `${geojson.properties.name}`, //设置文本标注内容
                                direction: 'right' //设置文本标注方位
                            });
                            AMap.event.addListener(marker, 'click', (e) => {
                                //创建右键菜单
                                var contextMenu = new AMap.ContextMenu();
                                let {
                                    type,
                                    id
                                } = marker.getExtData()
                               setMenu(obj, contextMenu, marker, coordinates,type,id,e.lnglat,geojson);
                            });
                            return marker;
                        }
                        return;
                    },
                    getPolyline: (geojson, lnglats) => {
                        return new AMap.Polyline({
                             path: lnglats,
                             strokeWeight: 3,
                             strokeOpacity: 0.2,
                            //  bubble: true,
                        })
                    }
                });
                geojson.setMap(map);
                console.log('GeoJSON 数据加载完成')
                // setTimeout(() => {
                //     map.setFitView(null, false, [150, 60, 100, 60]);
                // }, 2000)

            }),
            fail: ((err) => {
                console.log(err)
            })
        });
    </script>
</body>

</html>